<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>(推與敲) 第37篇 推敲 - 互動式古文學習 (GitHub版)</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 載入 FontAwesome 圖標 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 載入 Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fdfbf7; /* 米紙色 */
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .font-serif {
            font-family: 'Noto Serif TC', serif;
        }

        /* 自定義滾動條 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #d97706; 
            border-radius: 4px;
        }

        /* 標籤樣式 */
        .tab-btn {
            position: relative;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background-color: #b45309;
            transition: width 0.3s ease;
        }
        .tab-btn.active {
            color: #92400e;
            background-color: #fffbeb;
        }
        .tab-btn.active::after {
            width: 100%;
        }

        /* 互動文字樣式 */
        .interactive-word {
            cursor: pointer;
            border-bottom: 2px dotted #d97706;
            transition: all 0.2s;
            padding-bottom: 1px;
            position: relative;
            z-index: 20;
            color: #92400e;
            font-weight: 500;
        }
        .interactive-word:hover {
            background-color: #fef3c7;
            color: #b45309;
            border-bottom-style: solid;
        }

        /* 彈出註釋 */
        .note-popup {
            animation: fadeIn 0.2s ease-out;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px) translateX(-50%); }
            to { opacity: 1; transform: translateY(0) translateX(-50%); }
        }

        /* 懸停翻譯效果 */
        .hover-trans-container:hover .hover-translation {
            display: block;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 聊天氣泡 */
        .chat-bubble {
            max-width: 85%;
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            position: relative;
            line-height: 1.6;
        }
        .chat-user {
            background-color: #dbeafe; /* Blue-100 */
            color: #1e40af;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        .chat-ai {
            background-color: #fff;
            border: 1px solid #e5e7eb;
            color: #374151;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }

        /* 故事模式樣式 */
        .story-choice:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .fade-in-image {
            animation: fadeInImg 0.8s ease-out forwards;
        }
        @keyframes fadeInImg {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* 地圖與關係圖樣式 */
        .map-node {
            cursor: pointer;
            transition: r 0.3s ease, fill 0.3s ease;
        }
        .map-node:hover {
            fill: #d97706; /* amber-600 */
            r: 10;
            stroke: #fffbeb;
            stroke-width: 3;
        }
        .rel-node circle {
            transition: all 0.3s;
        }
        .rel-node:hover circle {
            fill: #fef3c7; /* amber-100 */
            stroke: #d97706; /* amber-600 */
            stroke-width: 3;
        }
        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            color: #4b5563;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
            max-width: 240px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #fcd34d;
        }
        .tooltip strong {
            display: block;
            color: #92400e;
            margin-bottom: 4px;
            font-size: 16px;
            border-bottom: 1px solid #fcd34d;
            padding-bottom: 4px;
        }

        /* 禁用狀態的樣式 */
        input[type="radio"]:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .disabled-label {
            cursor: not-allowed !important;
            opacity: 0.7;
        }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col">

    <!-- 頂部導航欄 -->
    <nav class="bg-amber-800 text-amber-50 shadow-lg sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-book-open text-2xl mr-3"></i>
                    <span class="font-bold text-xl tracking-wider">古文互動教室</span>
                </div>
                <div class="hidden md:block text-sm opacity-80">
                    GitHub Pages 版
                </div>
            </div>
        </div>
    </nav>

    <div id="app" class="max-w-5xl mx-auto p-4 sm:p-6 w-full flex-grow flex flex-col">
        
        <!-- 課程標題卡片 -->
        <header class="bg-white rounded-2xl shadow-md overflow-hidden mb-6 border border-amber-100">
            <div class="bg-gradient-to-r from-amber-100 to-orange-50 p-6 sm:p-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 id="main-title" class="text-3xl sm:text-4xl font-serif font-bold text-amber-900 mb-2"></h1>
                        <div class="flex items-center text-amber-700 space-x-4">
                            <span class="flex items-center"><i class="fas fa-user-edit mr-2"></i><span id="author-name"></span></span>
                            <span class="flex items-center"><i class="fas fa-scroll mr-2"></i><span id="source-name"></span></span>
                        </div>
                    </div>
                    <div class="hidden md:block">
                        <span class="inline-block bg-amber-200 text-amber-900 text-xs px-3 py-1 rounded-full font-bold uppercase tracking-wide">重要考試篇章</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- 功能標籤 -->
        <div class="flex flex-wrap justify-center bg-white rounded-xl shadow-sm mb-6 border border-gray-100 sticky top-20 z-40">
            <button id="tab-overview" class="tab-btn active px-4 py-3 md:px-6 md:py-4 font-medium text-gray-600 hover:text-amber-700" onclick="switchTab('overview')">
                <i class="fas fa-info-circle mr-2"></i>故事總覽
            </button>
            <button id="tab-reading" class="tab-btn px-4 py-3 md:px-6 md:py-4 font-medium text-gray-600 hover:text-amber-700" onclick="switchTab('reading')">
                <i class="fas fa-glasses mr-2"></i>精讀與圖解
            </button>
            <button id="tab-deep" class="tab-btn px-4 py-3 md:px-6 md:py-4 font-medium text-gray-600 hover:text-amber-700" onclick="switchTab('deep')">
                <i class="fas fa-project-diagram mr-2"></i>邏輯圖解
            </button>
            <button id="tab-story" class="tab-btn px-4 py-3 md:px-6 md:py-4 font-medium text-gray-600 hover:text-amber-700" onclick="switchTab('story')">
                <i class="fas fa-theater-masks mr-2"></i>抉擇之路(RPG)
            </button>
            <button id="tab-vocabulary" class="tab-btn px-4 py-3 md:px-6 md:py-4 font-medium text-gray-600 hover:text-amber-700" onclick="switchTab('vocabulary')">
                <i class="fas fa-spell-check mr-2"></i>語詞精解
            </button>
            <button id="tab-analysis" class="tab-btn px-4 py-3 md:px-6 md:py-4 font-medium text-gray-600 hover:text-amber-700" onclick="switchTab('analysis')">
                <i class="fas fa-feather-alt mr-2"></i>文義與修辭
            </button>
            <button id="tab-chat" class="tab-btn px-4 py-3 md:px-6 md:py-4 font-medium text-gray-600 hover:text-amber-700" onclick="switchTab('chat')">
                <i class="fas fa-robot mr-2"></i>AI 角色扮演
            </button>
            <button id="tab-quiz" class="tab-btn px-4 py-3 md:px-6 md:py-4 font-medium text-gray-600 hover:text-amber-700" onclick="switchTab('quiz')">
                <i class="fas fa-pen-nib mr-2"></i>隨堂測驗
            </button>
        </div>

        <!-- 主要內容區 -->
        <main id="content-display" class="flex-grow bg-white rounded-2xl shadow-lg p-6 sm:p-8 min-h-[500px] transition-all duration-300 relative">
            <!-- 內容動態載入 -->
        </main>
        
    </div>

    <!-- 註釋彈出框模板 -->
    <div id="note-template" class="note-popup absolute bg-white border-l-4 border-amber-500 rounded-r-lg shadow-2xl p-4 z-50 hidden w-72" onclick="event.stopPropagation()">
        <!-- 關閉按鈕 -->
        <button onclick="closeNote()" class="absolute top-2 right-2 text-gray-400 hover:text-amber-600 transition">
            <i class="fas fa-times"></i>
        </button>
        <div id="note-content">
            <!-- 內容動態填充 -->
        </div>
    </div>

    <!-- 結果模態框 (Score Modal) -->
    <div id="score-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 shadow-2xl transform transition-all scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-amber-100 mb-4">
                    <i class="fas fa-trophy text-2xl text-amber-600"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">測驗結果</h3>
                <p class="text-gray-500 mb-6" id="score-text">你的得分是...</p>
                <button onclick="closeScoreModal()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-amber-600 text-base font-medium text-white hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 sm:text-sm">
                    查看詳細解析
                </button>
            </div>
        </div>
    </div>

    <!-- 錯誤提示 -->
    <div id="error-toast" class="fixed bottom-6 right-6 bg-red-50 border border-red-200 text-red-600 px-6 py-4 rounded-lg shadow-xl hidden z-50 flex items-center transition-all transform translate-y-10 opacity-0">
        <i class="fas fa-exclamation-circle mr-3 text-xl"></i>
        <div>
            <p class="font-bold">發生錯誤</p>
            <p id="error-msg" class="text-sm"></p>
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // 1. 教材資料結構 (Content Data) - 王積薪聞棋
        // ----------------------------------------------------
        const contentData = {
            metadata: {
                title: "(推與敲) 第37篇 推敲",
                author: "胡梓引《劉公嘉話》/ 辛文房《唐才子傳》",
                source: "《唐詩紀事》/《唐才子傳》"
            },
            summary: "本篇記錄了唐代苦吟詩人賈島的兩則軼事。第一則敘述賈島初赴京師應試時，在驢背上斟酌「僧推月下門」與「僧敲月下門」二句，因過於專注而誤闖韓愈的儀仗隊。韓愈不僅未責怪，反而助其定字為「敲」，兩人因此結為布衣之交，這也是「推敲」一詞的典故由來。第二則敘述賈島落第後出家，法號無本。一日宣宗微服出巡至寺，賈島不識皇帝，因愛惜詩卷而對皇帝無禮，最終被貶為遂州長江簿。",
            
            meaning: "1. **精益求精的創作態度**：賈島「煉之未定」、「引手作推敲之勢」，展現了詩人對文字的嚴謹與執著，體現了「苦吟」精神。\n2. **寬容惜才的雅量**：韓愈身為顯貴（權京兆），遇賈島衝撞儀仗不僅不怒，反而立馬良久與之論詩，展現了上位者愛才、識才的風度。\n3. **藝術與世俗的衝突**：賈島因愛詩而不知禮法，甚至對皇帝無禮，反映了藝術家性格與世俗權威之間的張力，也導致仕途坎坷。",
            
            rhetoric: [
                "**煉字 (Refining Words):** 全篇核心在於「推」與「敲」的選擇。「敲」字以動襯靜，有聲音之美，更能襯托月夜的寧靜，且顯得有禮。",
                "**映襯 (Contrast):** 韓愈位高權重（吏部權京兆）與賈島身分低微（布衣/僧）形成對比；韓愈的寬容下士與賈島的痴迷忘我形成映襯。",
                "**動作描寫:** 「時時引手作推敲之勢」、「攬轡而歸」、「攘臂睨帝」等動作生動刻畫了人物性格。",
                "**側寫 (Side Description):** 「左右擁至尹前」寫出了儀仗的威嚴，反襯賈島「不覺」的專注。"
            ],
            
            // 36個詳盡語詞精解 - 全部將嵌入文言文中
            vocabulary: [
                { word: "島", zhuyin: "ㄉㄠˇ", pos: "名詞", meaning: "指賈島，唐代著名詩人，以苦吟著稱。" },
                { word: "初", zhuyin: "ㄔㄨ", pos: "副詞", meaning: "當初、第一次。" },
                { word: "赴舉", zhuyin: "ㄈㄨˋ ㄐㄩˇ", pos: "動詞", meaning: "前往參加科舉考試。" },
                { word: "京師", zhuyin: "ㄐㄧㄥ ㄕ", pos: "名詞", meaning: "國都，此指長安。" },
                { word: "得句", zhuyin: "ㄉㄜˊ ㄐㄩˋ", pos: "動詞", meaning: "構思得到詩句。" },
                { word: "煉", zhuyin: "ㄌㄧㄢˋ", pos: "動詞", meaning: "斟酌、推敲文字。" },
                { word: "未定", zhuyin: "ㄨㄟˋ ㄉㄧㄥˋ", pos: "形容詞", meaning: "尚未決定。" },
                { word: "遂", zhuyin: "ㄙㄨㄟˋ", pos: "副詞", meaning: "於是、就。" },
                { word: "吟哦", zhuyin: "ㄧㄣˊ ㄜˊ", pos: "動詞", meaning: "吟詠誦讀。" },
                { word: "引手", zhuyin: "ㄧㄣˇ ㄕㄡˇ", pos: "動詞", meaning: "伸出手。" },
                { word: "勢", zhuyin: "ㄕˋ", pos: "名詞", meaning: "姿勢、動作。" },
                { word: "吏部", zhuyin: "ㄌㄧˋ ㄅㄨˋ", pos: "名詞", meaning: "官署名，掌管官員任免考選。" },
                { word: "權", zhuyin: "ㄑㄩㄢˊ", pos: "動詞", meaning: "暫代官職。" },
                { word: "京兆", zhuyin: "ㄐㄧㄥ ㄓㄠˋ", pos: "名詞", meaning: "京兆尹，京城的地方長官。" },
                { word: "不覺", zhuyin: "ㄅㄨˋ ㄐㄩㄝˊ", pos: "動詞", meaning: "沒有察覺。" },
                { word: "衝", zhuyin: "ㄔㄨㄥ", pos: "動詞", meaning: "衝撞、闖入。" },
                { word: "第三節", zhuyin: "ㄉㄧˋ ㄙㄢ ㄐㄧㄝˊ", pos: "名詞", meaning: "儀仗隊的第三部分，指極接近主官的位置，闖入此區罪責極重。" },
                { word: "左右", zhuyin: "ㄗㄨㄛˇ ㄧㄡˋ", pos: "名詞", meaning: "隨從、侍衛。" },
                { word: "擁", zhuyin: "ㄩㄥˇ", pos: "動詞", meaning: "簇擁、推擠。" },
                { word: "尹", zhuyin: "ㄧㄣˇ", pos: "名詞", meaning: "長官，此指韓愈。" },
                { word: "具", zhuyin: "ㄐㄩˋ", pos: "副詞", meaning: "詳細、完備。" },
                { word: "立馬", zhuyin: "ㄌㄧˋ ㄇㄚˇ", pos: "動詞", meaning: "停馬駐足。" },
                { word: "良久", zhuyin: "ㄌㄧㄤˊ ㄐㄧㄡˇ", pos: "時間詞", meaning: "很久。" },
                { word: "並轡", zhuyin: "ㄅㄧㄥˋ ㄆㄟˋ", pos: "動詞", meaning: "馬頭齊平，並排騎行，表示地位平等或關係親密。" },
                { word: "布衣之交", zhuyin: "ㄅㄨˋ ㄧ ㄓ ㄐㄧㄠ", pos: "成語", meaning: "貧賤時的朋友，或顯貴者與平民建立的友誼。" },
                { word: "名著", zhuyin: "ㄇㄧㄥˊ ㄓㄨˋ", pos: "動詞", meaning: "名聲顯著。" },
                { word: "不第", zhuyin: "ㄅㄨˋ ㄉㄧˋ", pos: "動詞", meaning: "科舉落榜。" },
                { word: "微行", zhuyin: "ㄨㄟˊ ㄒㄧㄥˊ", pos: "動詞", meaning: "帝王穿著便服隱藏身分出巡。" },
                { word: "吟詠", zhuyin: "ㄧㄣˊ ㄩㄥˇ", pos: "動詞", meaning: "吟唱朗誦詩歌。" },
                { word: "案", zhuyin: "ㄢˋ", pos: "名詞", meaning: "桌子。" },
                { word: "覽", zhuyin: "ㄌㄢˇ", pos: "動詞", meaning: "觀看、閱讀。" },
                { word: "攘臂", zhuyin: "ㄖㄤˊ ㄅㄧˋ", pos: "動詞", meaning: "捲起袖子，這是一種不禮貌、準備爭執的動作。" },
                { word: "睨", zhuyin: "ㄋㄧˋ", pos: "動詞", meaning: "斜眼看，表示輕視或憤怒。" },
                { word: "何會", zhuyin: "ㄏㄜˊ ㄏㄨㄟˋ", pos: "疑問詞", meaning: "怎麼懂、哪裡懂得。" },
                { word: "慚恧", zhuyin: "ㄘㄢˊ ㄋㄩˋ", pos: "形容詞", meaning: "慚愧羞恥。" },
                { word: "除", zhuyin: "ㄔㄨˊ", pos: "動詞", meaning: "授予官職。" }
            ],

            segments: [
                {
                    original: "島初赴舉京師，一日，於驢上得句云：「鳥宿池邊樹，僧敲月下門。」",
                    translation: "賈島初次前往京城長安參加科舉考試，有一天，他在驢背上構思得到兩句詩：「鳥兒棲宿在池邊的樹上，僧人敲著月光下的門。」",
                    audioText: "島初赴舉京師，一日，於驢上得句云：鳥宿池邊樹，僧敲月下門。",
                    notes: {},
                    // Modified image path for GitHub Pages
                    imageData: "images/reading_segment_1.jpg"
                },
                {
                    original: "始欲著「推」字，又欲作「敲」字，煉之未定，遂於驢上吟哦，時時引手作推敲之勢。",
                    translation: "剛開始想用「推」字，後來又想改用「敲」字，反覆斟酌未能決定，於是在驢背上吟詠誦讀，還不時伸出手做出推門和敲門的動作。",
                    audioText: "始欲著推字，又欲作敲字，煉之未定，遂於驢上吟哦，時時引手作推敲之勢。",
                    notes: {},
                    imageData: "images/reading_segment_2.jpg"
                },
                {
                    original: "時韓愈吏部權京兆，島不覺，衝至第三節。左右擁至尹前，島具對所得詩句云云。",
                    translation: "當時韓愈在吏部任職並暫代京兆尹（長安市長），賈島太專注沒察覺，竟然衝撞進儀仗隊的第三節（核心警戒區）。隨從侍衛將他擁推到韓愈面前，賈島詳細回答了關於得到詩句的經過。",
                    audioText: "時韓愈吏部權京兆，島不覺，衝至第三節。左右擁至尹前，島具對所得詩句云云。",
                    notes: {},
                    imageData: "images/reading_segment_3.jpg"
                },
                {
                    original: "韓立馬良久，謂島曰：「作『敲』字佳矣。」遂並轡而歸。留連論詩，與為布衣之交。",
                    translation: "韓愈停馬思考了很久，對賈島說：「用『敲』字比較好。」於是兩人並排騎馬回去。他們流連在一起討論詩歌，韓愈與身為平民的賈島結為了朋友。",
                    audioText: "韓立馬良久，謂島曰：作敲字佳矣。遂並轡而歸。留連論詩，與為布衣之交。",
                    notes: {},
                    imageData: "images/reading_segment_4.jpg"
                },
                {
                    original: "自此名著。後以不第，乃為僧，居法乾寺，號無本。一日，宣宗微行至寺，聞鐘樓吟詠聲，",
                    translation: "從此賈島名聲大噪。後來因為科舉落榜，便出家為僧，住在法乾寺，法號無本。有一天，唐宣宗微服出巡來到寺裡，聽到鐘樓上有吟詠詩歌的聲音，",
                    audioText: "自此名著。後以不第，乃為僧，居法乾寺，號無本。一日，宣宗微行至寺，聞鐘樓吟詠聲，",
                    notes: {},
                    imageData: "images/reading_segment_5.jpg"
                },
                {
                    original: "遂登樓，於島案上取詩卷覽之。島不識帝，遂攘臂睨帝曰：「郎君何會此邪？」遂奪取詩卷。",
                    translation: "於是登上鐘樓，在賈島的桌案上拿起詩卷閱讀。賈島不認識皇帝，竟然捲起袖子斜眼看著皇帝說：「你這富家公子懂什麼詩？」說完便奪回詩卷。",
                    audioText: "遂登樓，於島案上取詩卷覽之。島不識帝，遂攘臂睨帝曰：郎君何會此邪？遂奪取詩卷。",
                    notes: {},
                    imageData: "images/reading_segment_6.jpg"
                },
                {
                    original: "帝慚恧下樓而去，遂除島為遂州長江簿。",
                    translation: "皇帝感到慚愧羞恥，下樓離開，後來便任命（貶謫）賈島為遂州長江縣的主簿。",
                    audioText: "帝慚恧下樓而去，遂除島為遂州長江簿。",
                    notes: {},
                    imageData: "images/reading_segment_7.jpg"
                }
            ],
            // 隨堂測驗 (高難度)
            quiz: [
                { q: "文中「權」京兆的「權」字，在官制術語中的意思為何？", opts: ["A. 權力很大", "B. 暫代官職", "C. 權衡輕重", "D. 掌握實權"], ans: "B", exp: "「權」在古代官制中指「暫代」或「代理」官職。" },
                { q: "「衝至第三節」之所以嚴重，是因為「第三節」通常指什麼？", opts: ["A. 儀仗隊的最尾端", "B. 儀仗隊的最前端", "C. 接近主官的核心警戒區", "D. 圍觀群眾的第三層"], ans: "C", exp: "唐代儀仗分導從，第三節極接近主官，闖入此區是對官員極大的冒犯。" },
                { q: "韓愈認為「敲」字佳，下列何者「不是」主要原因？", opts: ["A. 敲字有聲音，以動襯靜", "B. 僧人夜歸敲門較合乎禮節", "C. 敲字平仄較為協韻", "D. 推字太過輕柔無力"], ans: "D", exp: "主要原因是「敲」有聲響更能襯托月夜寧靜（鳥宿），且夜深敲門為禮，並非推字無力。" },
                { q: "文中「布衣之交」形容韓愈與賈島的關係，重點在於？", opts: ["A. 兩人都穿著布衣", "B. 跨越身分地位的友誼", "C. 兩人都喜愛布料", "D. 只是泛泛之交"], ans: "B", exp: "韓愈為高官，賈島為平民（布衣），此成語強調不因身分懸殊而阻礙友誼。" },
                { q: "賈島「攘臂睨帝」的動作，反映了他當下的什麼心態？", opts: ["A. 恭敬不如從命", "B. 恐懼戰兢", "C. 輕視且護惜作品", "D. 熱情好客"], ans: "C", exp: "「攘臂」是捲袖準備爭執，「睨」是斜眼看，顯示他輕視眼前這位「不懂詩的富家公子」並保護自己的詩作。" },
                { q: "「除」島為遂州長江簿，「除」字作何解？", opts: ["A. 免除官職", "B. 除去罪名", "C. 授予官職", "D. 開除學籍"], ans: "C", exp: "「除」在古文中常指「拜官」、「授職」，雖此處實為貶謫，但動詞本身是任命之意。" },
                { q: "賈島號「無本」，其身分為？", opts: ["A. 道士", "B. 僧人", "C. 儒生", "D. 商人"], ans: "B", exp: "文中提及「乃為僧...號無本」。" },
                { q: "「郎君何會此邪？」這句話的語氣是？", opts: ["A. 虛心請教", "B. 驚喜相認", "C. 輕蔑質疑", "D. 悲傷感嘆"], ans: "C", exp: "意指「你這富家子弟哪裡懂得詩？」，充滿輕蔑。" },
                { q: "下列哪個成語最適合形容賈島「煉之未定」的狀態？", opts: ["A. 一揮而就", "B. 搜索枯腸", "C. 信手拈來", "D. 倚馬可待"], ans: "B", exp: "形容竭力思索，與苦吟精神相符。其他皆指才思敏捷。" },
                { q: "韓愈「立馬良久」展現了什麼樣的修養？", opts: ["A. 猶豫不決", "B. 威嚴不可侵犯", "C. 尊重文學與寬容", "D. 正在思考如何處罰"], ans: "C", exp: "他不計較衝撞，反而認真思考字句，展現雅量與對文學的尊重。" },
                { q: "「微行」一詞暗示了宣宗當時的狀態為？", opts: ["A. 微微行走", "B. 隱藏身分出巡", "C. 身體微恙", "D. 施行仁政"], ans: "B", exp: "微行指帝王著便服私訪。" },
                { q: "賈島最終被貶為長江簿，主要原因為何？", opts: ["A. 詩寫得不好", "B. 衝撞韓愈", "C. 不識帝且無禮", "D. 貪污受賄"], ans: "C", exp: "因對微服的皇帝無禮（奪卷、攘臂睨帝）而被貶。" },
                { q: "文中「不覺」二字，在修辭上起到了什麼作用？", opts: ["A. 誇飾賈島的愚笨", "B. 側面描寫賈島的專注", "C. 譬喻賈島如盲人", "D. 映襯韓愈的清醒"], ans: "B", exp: "寫他專注於詩句思考，以致對外界環境毫無知覺。" },
                { q: "關於「鳥宿池邊樹，僧敲月下門」，下列賞析何者有誤？", opts: ["A. 對仗工整", "B. 動靜相襯", "C. 描寫熱鬧的市集場景", "D. 營造幽靜的氛圍"], ans: "C", exp: "描寫的是幽靜的月夜山寺場景，非鬧市。" },
                { q: "「並轡而歸」暗示了韓愈對賈島的態度轉變為？", opts: ["A. 押解犯人", "B. 平等相待", "C. 勉強應付", "D. 視為隨從"], ans: "B", exp: "並轡指馬頭齊平，顯示不再是官與民的上下關係，而是平等的文友。" },
                { q: "「帝慚恧下樓而去」中的「慚恧」意指？", opts: ["A. 憤怒", "B. 慚愧羞恥", "C. 恐懼", "D. 悲傷"], ans: "B", exp: "恧，音ㄋㄩˋ，慚愧之意。皇帝因被嗆不懂詩而感到不好意思。" },
                { q: "「島具對所得詩句云云」，「云云」的意思是？", opts: ["A. 說話不知所云", "B. 如此這般（省略語）", "C. 天上的雲", "D. 很多雲"], ans: "B", exp: "指「如此這般」，省略詳細的敘述內容。" },
                { q: "賈島的詩風屬於唐詩中的哪一派？", opts: ["A. 浪漫派", "B. 邊塞派", "C. 苦吟派/怪奇", "D. 田園派"], ans: "C", exp: "賈島與孟郊並稱「郊寒島瘦」，為苦吟詩人代表。" },
                { q: "「尹」在「左右擁至尹前」中是指？", opts: ["A. 尹姓官員", "B. 縣令", "C. 京兆尹韓愈", "D. 丞相"], ans: "C", exp: "指京兆尹，即當時的韓愈。" },
                { q: "這兩則故事共同凸顯了賈島的什麼性格特質？", opts: ["A. 圓滑世故", "B. 汲汲營營", "C. 痴迷文學不拘小節", "D. 膽小怕事"], ans: "C", exp: "無論是衝撞儀仗還是對皇帝無禮，都源於他對詩歌的痴迷與專注。" }
            ]
        }; // ContentData ends here

        // 預處理所有關鍵字 (將 contentData.vocabulary 轉為 Map 結構)
        const allKeywords = {};
        contentData.vocabulary.forEach((item) => {
             allKeywords[item.word] = item;
        });

        // ----------------------------------------------------
        // 2. 全域狀態管理
        // ----------------------------------------------------
        let currentTab = 'overview';
        let chatHistory = [];
        let isGeneratingImage = false;
        let currentAudio = null;
        let currentPersona = 'jiadao'; 
        let hasPreloadedStory = false;
        let userAnswers = {}; 

        const personas = {
            jiadao: {
                name: "賈島",
                icon: "fas fa-user-edit",
                color: "amber",
                intro: "貧僧無本，俗名賈島。施主也愛詩嗎？這「推」與「敲」二字，貧僧至今仍在琢磨...若是您，會選哪一個呢？",
                systemPrompt: "你現在扮演唐代苦吟詩人賈島（法號無本）。你對文字極度執著，性格有些孤僻但談到詩歌就非常熱情。你會用謙虛但執著的語氣對話，並堅持認為「敲」字較好，因為有聲音能襯托靜謐。"
            },
            hanyu: {
                name: "韓愈",
                icon: "fas fa-user-tie",
                color: "blue",
                intro: "老夫韓退之。那日在大街上遇見一位騎驢苦吟的書生，雖衝撞儀仗，但其求道之心可嘉。為官者，當識才愛才啊。",
                systemPrompt: "你現在扮演唐代文壇領袖韓愈。你說話文雅、威嚴但從容，具有長者風範。你很欣賞賈島的才華，並不介意他的無禮，會強調文學比禮法更重要。"
            },
            emperor: {
                name: "唐宣宗",
                icon: "fas fa-crown",
                color: "yellow",
                intro: "朕微服出巡，本想求個清靜，沒想到被個和尚教訓了一頓！不過...他說朕不懂詩，朕當時還真有點羞愧呢。",
                systemPrompt: "你現在扮演唐宣宗。你有點尷尬但又身為皇帝的尊嚴。你承認自己當時被賈島的氣勢嚇到，但後來還是覺得該給他點顏色瞧瞧（貶官），語氣中帶有帝王的傲氣。"
            }
        };

        // [Tab Story] 抉擇之路 (RPG)
        const storyNodes = {
            start: {
                id: 'start',
                text: "你是賈島，此刻正騎在驢背上，準備前往長安應試。你腦中突然浮現兩句好詩：「鳥宿池邊樹，僧＿月下門。」你正在猶豫該用哪個字...",
                // Modified for GitHub
                imageData: "images/rpg_start.jpg",
                choices: [
                    { text: "覺得「推」字好，安靜不擾人", next: "push" },
                    { text: "覺得「敲」字好，以動襯靜", next: "knock" }
                ]
            },
            push: {
                id: 'push',
                text: "你決定用「推」字。你沉浸在詩句中，閉著眼在驢背上做推門的手勢。突然，你感覺撞到了什麼東西...",
                // No specific image, reuse start or similar if needed
                imageData: "images/rpg_push.jpg", 
                choices: [
                    { text: "睜開眼看發生什麼事", next: "collision" }
                ]
            },
            knock: {
                id: 'knock',
                text: "你覺得「敲」字更有韻味。你一邊吟哦，一邊伸手做敲門的動作。完全沒注意到前方有大官的儀仗隊...",
                 imageData: "images/rpg_knock.jpg",
                choices: [
                    { text: "繼續沉浸在詩中", next: "collision" }
                ]
            },
            collision: {
                id: 'collision',
                text: "糟了！你衝進了京兆尹韓愈的儀仗隊第三節！左右侍衛立刻將你拿下，推到韓愈馬前。韓愈問你為何亂闖，你該怎麼辦？",
                imageData: "images/rpg_collision.jpg", // Reusing image from previous context
                choices: [
                    { text: "嚇得趕緊磕頭求饒", next: "bad_end_1" },
                    { text: "誠實以此詩句相告，請教用字", next: "good_end" }
                ]
            },
            bad_end_1: {
                id: 'bad_end_1',
                text: "【Bad Ending: 庸人自擾】你嚇得說不出話，只知道求饒。韓愈見你膽小如鼠，覺得無趣，便讓人把你趕走了。你錯失了結交文壇領袖的機會。",
                imageData: "images/rpg_bad_ignorant.jpg",
                choices: [{ text: "重來", next: "start" }],
                isEnding: true
            },
            good_end: {
                id: 'good_end',
                text: "【Good Ending: 推敲千古】韓愈聽了你的詩，立馬良久，說：「作『敲』字佳矣。」他欣賞你的才華，與你並轡而歸，結為布衣之交。「推敲」的典故流傳千古。",
                imageData: "images/rpg_good_end.jpg",
                choices: [{ text: "繼續你的人生 (遇見皇帝)", next: "emperor_encounter" }],
                isEnding: false,
                win: true
            },
            emperor_encounter: {
                id: 'emperor_encounter',
                text: "多年後，你出家為僧。一日，你在鐘樓讀詩，不知唐宣宗微服來到身後拿起你的詩卷。你會...",
                imageData: "images/rpg_emperor.jpg", // Using memorize image as placeholder for reading poem
                choices: [
                    { text: "轉身行禮，恭敬讓座", next: "boring_end" },
                    { text: "生氣地奪回詩卷，罵他不懂詩", next: "true_poet_end" }
                ]
            },
            boring_end: {
                id: 'boring_end',
                text: "【Normal Ending: 平凡僧人】你認出了皇帝（或只是單純客氣），皇帝覺得無趣便走了。你保住了平安，但也失去了一個展現真性情的機會。",
                imageData: "images/rpg_boring_end.jpg",
                choices: [{ text: "重來", next: "start" }],
                isEnding: true
            },
            true_poet_end: {
                id: 'true_poet_end',
                text: "【True Ending: 痴狂詩人】你怒斥：「郎君何會此邪？」並奪回詩卷。雖然因此被貶為長江簿，但你對詩歌的痴狂與傲骨，讓你成為了獨一無二的苦吟詩人。",
                imageData: "images/rpg_true_poet.jpg",
                choices: [{ text: "重來", next: "start" }],
                isEnding: true,
                win: true
            }
        };

        window.onload = function() {
            document.getElementById('main-title').textContent = contentData.metadata.title;
            document.getElementById('author-name').textContent = contentData.metadata.author;
            document.getElementById('source-name').textContent = contentData.metadata.source;
            switchTab('overview');

            // 確保按鈕被綁定 (修復 switchTab is not defined)
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const onClickAttr = this.getAttribute('onclick');
                    if (onClickAttr) {
                        const match = onClickAttr.match(/switchTab\('([^']+)'\)/);
                        if (match && match[1]) {
                            switchTab(match[1]);
                        }
                    }
                });
            });

            // 但因為 HTML 已經寫死 onclick="switchTab(...)"，瀏覽器會先執行它。
            // 如果 switchTab 定義在 window 上就沒問題。
            // 我們把 switchTab 掛載到 window 物件
            window.switchTab = switchTab;
            window.showNote = showNote;
            window.closeNote = closeNote;
            window.playAudio = playAudio;
            window.checkAnswer = checkAnswer;
            window.submitQuiz = submitQuiz;
            window.closeScoreModal = closeScoreModal;
            window.switchPersona = switchPersona;
            window.handleChatSubmit = handleChatSubmit;
            window.nextStoryNode = nextStoryNode;
            window.renderStory = renderStory;

            if ('speechSynthesis' in window) {
                 window.speechSynthesis.onvoiceschanged = function() {
                    window.speechSynthesis.getVoices();
                };
            }

            document.addEventListener('click', (e) => {
                const popup = document.getElementById('note-template');
                if (!e.target.closest('.interactive-word') && !e.target.closest('.note-popup')) {
                    closeNote();
                }
            });
        };

        function closeNote() {
            const popup = document.getElementById('note-template');
            if(popup) {
                popup.classList.add('hidden');
                popup.style.display = ''; 
            }
        }

        function switchTab(tabId) {
            currentTab = tabId;
            closeNote();

            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');

            const container = document.getElementById('content-display');
            container.style.opacity = '0';
            
            setTimeout(() => {
                switch(tabId) {
                    case 'overview': renderOverview(container); break;
                    case 'reading': renderReading(container); break;
                    case 'deep': renderDeepUnderstanding(container); break;
                    case 'vocabulary': renderVocabulary(container); break;
                    case 'analysis': renderAnalysis(container); break;
                    case 'chat': renderChat(container); break;
                    case 'quiz': renderQuiz(container); break;
                    case 'story': 
                        renderStory(container); 
                        break;
                }
                container.style.opacity = '1';
            }, 200);
        }

        function renderOverview(container) {
            container.innerHTML = `
                <div class="max-w-3xl mx-auto">
                    <div class="bg-amber-50 rounded-xl p-6 border-l-8 border-amber-600 mb-8">
                        <h2 class="text-2xl font-bold text-amber-900 mb-4"><i class="fas fa-scroll mr-2"></i>故事大意</h2>
                        <p class="text-lg text-gray-700 leading-loose text-justify">${contentData.summary}</p>
                    </div>
                    
                    <div class="flex justify-center">
                         <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm hover:shadow-md transition flex flex-col justify-center items-center text-center max-w-md w-full">
                            <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mb-4">
                                <i class="fas fa-lightbulb text-amber-600 text-2xl"></i>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-2">學習重點</h3>
                            <p class="text-gray-600 text-sm">體會「苦吟」精神，理解「推敲」典故，並學習韓愈寬容愛才的風範。</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderReading(container) {
            let segmentsHtml = contentData.segments.map((seg, idx) => {
                let displayHtml = seg.original;
                // 智慧嵌入所有關鍵字
                const sortedKeys = Object.keys(allKeywords).sort((a, b) => b.length - a.length);
                const placeholders = {};
                let counter = 0;

                sortedKeys.forEach(key => {
                    if (displayHtml.includes(key)) {
                        const ph = `___PH${counter}___`;
                        placeholders[ph] = key;
                        displayHtml = displayHtml.split(key).join(ph);
                        counter++;
                    }
                });

                Object.keys(placeholders).forEach(ph => {
                    const key = placeholders[ph];
                    displayHtml = displayHtml.split(ph).join(`<span class="interactive-word" onclick="showNote('${key}', ${idx}, this, event)">${key}</span>`);
                });

                // GitHub Path
                let imageSection = `<div class="mt-6 rounded-lg overflow-hidden shadow-lg animate-fade-in"><img src="${seg.imageData}" class="w-full h-auto rounded-lg shadow-md" alt="段落插圖" onerror="this.style.display='none'"></div>`;

                return `
                    <div class="group mb-12 relative pl-6 border-l-4 border-gray-200 hover:border-amber-500 transition-colors duration-300">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">段落 ${idx + 1}</span>
                            <div class="flex gap-2">
                                <button onclick="playAudio('${seg.audioText}')" class="w-8 h-8 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center hover:bg-amber-200 transition" title="朗讀">
                                    <i class="fas fa-volume-up text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <div class="relative hover-trans-container cursor-help py-2">
                            <p class="text-2xl sm:text-3xl font-serif text-gray-800 leading-relaxed relative z-10">${displayHtml}</p>
                            <div class="hover-translation hidden absolute left-0 top-full mt-2 w-full z-20">
                                <div class="bg-white/95 backdrop-blur-sm p-4 rounded-lg text-gray-700 text-lg leading-7 border border-amber-200 shadow-xl relative">
                                    <div class="absolute -top-2 left-8 w-4 h-4 bg-white border-t border-l border-amber-200 transform rotate-45"></div>
                                    <span class="font-bold text-amber-700 mr-1"><i class="fas fa-language mr-1"></i>語譯：</span> ${seg.translation}
                                </div>
                            </div>
                        </div>
                        ${imageSection}
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="flex flex-col md:flex-row gap-6 mb-8 items-center bg-amber-50 p-4 rounded-xl border border-amber-100">
                    <div class="flex-grow">
                        <h3 class="font-bold text-amber-900 text-lg">古文閱讀</h3>
                        <p class="text-sm text-amber-700">點擊文字可查看註釋，滑鼠懸停可查看翻譯。</p>
                    </div>
                </div>
                <div class="max-w-3xl mx-auto">
                    ${segmentsHtml}
                </div>
            `;
        }
        
        function renderDeepUnderstanding(container) {
             container.innerHTML = `<div class="text-center p-10">邏輯圖解內容 (請參考完整代碼)</div>`; 
        }

        function renderVocabulary(container) {
             const cardsHtml = contentData.vocabulary.map(item => `
                <div class="bg-white border border-amber-100 rounded-xl p-5 shadow-sm hover:shadow-md transition duration-200 flex flex-col h-full">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-2xl font-bold text-amber-900">${item.word}</h3>
                    </div>
                    <div class="text-sm text-gray-500 mb-2 font-mono bg-amber-50 inline-block px-2 py-1 rounded self-start">
                        ${item.zhuyin} • <span class="text-amber-700 font-semibold">${item.pos}</span>
                    </div>
                    <p class="text-gray-700 text-lg leading-relaxed flex-grow">${item.meaning}</p>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-3xl font-bold text-center mb-8 text-amber-900 font-serif">語詞精解</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${cardsHtml}
                    </div>
                </div>
            `;
        }
        
        function renderAnalysis(container) {
              const rhetoricHtml = contentData.rhetoric.map(r => `
                <div class="flex items-start mb-4 p-4 bg-white rounded-lg border border-gray-100 shadow-sm">
                    <div class="flex-shrink-0 mr-4">
                        <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center text-amber-600 font-bold">
                            <i class="fas fa-pen-fancy"></i>
                        </div>
                    </div>
                    <div>
                        ${marked.parse(r)}
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="max-w-3xl mx-auto space-y-10">
                    <section>
                        <h2 class="text-2xl font-bold text-amber-900 mb-4 flex items-center">
                            <i class="fas fa-book-reader mr-3"></i>全文主旨與寓意
                        </h2>
                        <div class="bg-amber-50 p-6 rounded-xl border-l-8 border-amber-600 shadow-sm text-lg text-gray-800 leading-loose">
                            ${marked.parse(contentData.meaning)}
                        </div>
                    </section>
                    <section>
                        <h2 class="text-2xl font-bold text-amber-900 mb-4 flex items-center">
                            <i class="fas fa-highlighter mr-3"></i>修辭與寫作技巧
                        </h2>
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                            ${rhetoricHtml}
                        </div>
                    </section>
                </div>
            `;
        }
        
        function renderChat(container) {
             container.innerHTML = `<div class="flex flex-col h-[400px] items-center justify-center text-gray-500">
                <i class="fas fa-robot text-4xl mb-4 text-gray-300"></i>
                <p>AI 角色扮演功能僅支援線上模式。</p>
                <p class="text-sm mt-2">（本地版不具備連網對話能力）</p>
            </div>`;
        }
        
        function renderQuiz(container) {
             let quizHtml = contentData.quiz.map((q, i) => {
                const val = ["A","B","C","D"];
                const isAnswered = userAnswers[i] !== undefined;
                const userAnswer = userAnswers[i];
                let feedback = '';
                let cardClass = "bg-white border border-gray-200";
                let feedbackClass = "hidden mt-4 p-3 rounded-lg text-lg bg-gray-50"; 
                
                if (isAnswered) {
                    feedbackClass = "mt-4 p-3 rounded-lg text-lg animate-fade-in"; 
                    if (userAnswer === q.ans) {
                        feedback = `<strong class="block mb-1"><i class="fas fa-check-circle mr-1"></i>答對了！</strong>${q.exp}`;
                        cardClass = "bg-white border border-green-500 shadow-sm";
                        feedbackClass += " bg-green-50 text-green-800";
                    } else {
                        feedback = `<strong class="block mb-1"><i class="fas fa-times-circle mr-1"></i>再想一下...</strong>提示：${q.exp.substring(0, 15)}...`;
                        cardClass = "bg-white border border-red-500 shadow-sm";
                        feedbackClass += " bg-red-50 text-gray-800";
                    }
                }

                return `
                <div class="${cardClass} rounded-xl p-6 mb-6 shadow-sm transition-all duration-300" id="quiz-card-${i}">
                    <p class="font-bold text-2xl text-gray-800 mb-4"><span class="text-amber-600 mr-2">Q${i+1}.</span>${q.q}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${q.opts.map((opt, optIdx) => {
                            const val = ["A","B","C","D"][optIdx];
                            const isChecked = userAnswer === val ? 'checked' : '';
                            const isDisabled = isAnswered ? 'disabled' : '';
                            
                            return `
                            <label class="flex items-center p-3 rounded-lg border border-gray-100 hover:bg-amber-50 cursor-pointer transition group">
                                <input type="radio" name="q-${i}" value="${val}" class="mr-3 text-amber-600 focus:ring-amber-500" onchange="checkAnswer(${i}, '${val}', '${q.ans}')" ${isChecked} ${isDisabled}>
                                <span class="text-xl group-hover:text-amber-800">${opt}</span>
                            </label>
                            `;
                        }).join('')}
                    </div>
                    <div id="feedback-${i}" class="${feedbackClass}">${feedback}</div>
                </div>
            `}).join('');
            
            container.innerHTML = `
                <div class="max-w-3xl mx-auto pb-24">
                    <h2 class="text-2xl font-bold text-center mb-8 text-gray-700">小試身手 (共20題)</h2>
                    ${quizHtml}
                    <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-4 shadow-lg flex justify-center items-center z-40">
                         <button onclick="submitQuiz()" class="px-8 py-3 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-full shadow-lg transition transform hover:scale-105 flex items-center text-lg">
                            <i class="fas fa-paper-plane mr-2"></i> 交卷並查看成績
                        </button>
                    </div>
                </div>
            `;
        }

        // 定義其他 window 函數
        function handleChatSubmit(e) { e.preventDefault(); }
        function showMapTooltip() {}
        function hideMapTooltip() {}

    </script>
</body>
</html>